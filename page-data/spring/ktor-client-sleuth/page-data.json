{"componentChunkName":"component---src-templates-post-template-tsx","path":"/spring/ktor-client-sleuth/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h1>ktor-client sleuth 적용하기</h1>\n<p>sleuth 는 spring cloud 에서 제공하는 분산 추적 시스템이다.\nMSA 환경에서 트랜잭션을 추적하고 로깅을 할 때 사용된다.\n기본적으로 RestTemplate 이나 WebClient 는 기본적으로 라이브러리를 추가할 시 자동으로 적용되지만\n나머지 HTTP Client 들에는 직접 적용해줄 필요가 있다.</p>\n<h2>프로젝트 셋업</h2>\n<p>Client</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlindsl\"><pre class=\"language-kotlindsl\"><code class=\"language-kotlindsl\">// build.gradle.kts  \ndependencies {\n    implementation(project(&quot;:support:logging&quot;))\n    implementation(&quot;io.ktor:ktor-client-core:${rootProject.extra[&quot;ktorVersion&quot;]}&quot;)\n    implementation(&quot;io.ktor:ktor-client-cio:${rootProject.extra[&quot;ktorVersion&quot;]}&quot;)\n    implementation(&quot;org.springframework.boot:spring-boot-starter-web&quot;)\n    \n    implementation(&quot;org.springframework.cloud:spring-cloud-starter-sleuth&quot;)\n}</code></pre></div>\n<p>Server</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlindsl\"><pre class=\"language-kotlindsl\"><code class=\"language-kotlindsl\">// build.gradle.kts\ndependencies {\n    implementation(project(&quot;:support:logging&quot;))\n    implementation(&quot;org.springframework.boot:spring-boot-starter-web&quot;)\n    \n    implementation(&quot;org.springframework.cloud:spring-cloud-starter-sleuth&quot;)\n}</code></pre></div>\n<h3>ktor-client features</h3>\n<p>HTTP 요청에 Header 설정을 추가해주면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> SleuthHeader <span class=\"token keyword\">internal</span> <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">val</span> tracer<span class=\"token operator\">:</span> Tracer\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> Config <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">internal</span> <span class=\"token keyword\">lateinit</span> <span class=\"token keyword\">var</span> tracer<span class=\"token operator\">:</span> Tracer\n\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">tracer</span><span class=\"token punctuation\">(</span>tracer<span class=\"token operator\">:</span> Tracer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>tracer <span class=\"token operator\">=</span> tracer\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">setupRequest</span><span class=\"token punctuation\">(</span>client<span class=\"token operator\">:</span> HttpClient<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        client<span class=\"token punctuation\">.</span>requestPipeline<span class=\"token punctuation\">.</span><span class=\"token function\">intercept</span><span class=\"token punctuation\">(</span>HttpRequestPipeline<span class=\"token punctuation\">.</span>State<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">val</span> span <span class=\"token operator\">=</span> tracer<span class=\"token punctuation\">.</span><span class=\"token function\">currentSpan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?:</span> tracer<span class=\"token punctuation\">.</span><span class=\"token function\">nextSpan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            context<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"X-B3-TraceId\"</span></span><span class=\"token punctuation\">,</span> span<span class=\"token punctuation\">.</span><span class=\"token function\">context</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">traceId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            context<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"X-B3-SpanId\"</span></span><span class=\"token punctuation\">,</span> tracer<span class=\"token punctuation\">.</span><span class=\"token function\">nextSpan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">context</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">spanId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            context<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"X-B3-ParentSpanId\"</span></span><span class=\"token punctuation\">,</span> tracer<span class=\"token punctuation\">.</span><span class=\"token function\">nextSpan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">context</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">parentId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> HttpClientFeature<span class=\"token operator\">&lt;</span>Config<span class=\"token punctuation\">,</span> SleuthHeader<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">val</span> key<span class=\"token operator\">:</span> AttributeKey<span class=\"token operator\">&lt;</span>SleuthHeader<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">AttributeKey</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"SleuthHeaderPlugin\"</span></span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">install</span><span class=\"token punctuation\">(</span>feature<span class=\"token operator\">:</span> SleuthHeader<span class=\"token punctuation\">,</span> scope<span class=\"token operator\">:</span> HttpClient<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            feature<span class=\"token punctuation\">.</span><span class=\"token function\">setupRequest</span><span class=\"token punctuation\">(</span>scope<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span>block<span class=\"token operator\">:</span> Config<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> Unit<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> SleuthHeader <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">val</span> config <span class=\"token operator\">=</span> <span class=\"token function\">Config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">SleuthHeader</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>tracer<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Configuration</span>\n<span class=\"token keyword\">class</span> KtorConfiguration <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation builtin\">@Bean</span>\n    <span class=\"token annotation builtin\">@Primary</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">httpClient</span><span class=\"token punctuation\">(</span>objectMapper<span class=\"token operator\">:</span> ObjectMapper<span class=\"token punctuation\">,</span> tracer<span class=\"token operator\">:</span> Tracer<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> HttpClient <span class=\"token operator\">=</span> <span class=\"token function\">HttpClient</span><span class=\"token punctuation\">(</span>CIO<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">install</span><span class=\"token punctuation\">(</span>SleuthHeader<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">tracer</span><span class=\"token punctuation\">(</span>tracer<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n       \n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","fields":{"category":"spring"},"frontmatter":{"title":"ktor-client sleuth 적용하기","summary":"ktor client 에서 sleuth 를 적용하는 방법을 알아보자.","date":"2022.09.25.","tags":["ktor"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjElEQVR42u2U207CQBCG+8g+go9hYvTCExeoGAWDB2JQsIDFghwUiJwKrXLoAkVUvPidWUAw8cIE4pUXf3e7s/v905lmlZ5dwyKl/AMXC3REfXFAhomWgX5nPqjSIchwYCEQTGBp2YtS8REv3Qm0Do5326zaeBypJ+j9RyAFPwioJ+/hP9cl8K1vwm5U5YHhi4W3nol3h0bHJFl4pZGNBrTuiJrUt082KkX4Azo8xzcIhu9kBmo0De9pHFEtg0TyAXriHvHbrDSOxTO4UlNIp3MQTQNtNm+Pgc2nKjTamM8XcKNlkcsVpI78GtZdIRyQyfZeBKtbIbgPY9h0q3DtRxCOpOAjQzU2Mj670FEghsKHr65TaBGYg+x4QtnG9ax05lpxWdidY9y4SUY8t2mNy1MpF9GwKlCezQplEsbaTghbuypWNi7h8Wl4pfpMOu5Qc7hOfVGXf8PXupiKG8kxhR/sxkUWY/Hmrj3t4uz8V//hrNNsx/4vhz8CitE9MNKcQIY0n8owjBLsliX1CTPZynf2Ss39AAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png","srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/f1689/common.png 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/42fd3/common.png 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png 1080w","sizes":"(min-width: 1080px) 1080px, 100vw"},"sources":[{"srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/7e223/common.webp 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/5cfb6/common.webp 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/941f9/common.webp 1080w","type":"image/webp","sizes":"(min-width: 1080px) 1080px, 100vw"}]},"width":1080,"height":1080}},"publicURL":"/static/a229594a2de7c0ed63d877869e75fd38/common.png"}}}}]}},"pageContext":{"slug":"/spring/ktor-client-sleuth/","category":"spring"}},"staticQueryHashes":["2433549356","3142469158"],"slicesMap":{}}