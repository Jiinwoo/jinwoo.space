{"componentChunkName":"component---src-templates-post-template-tsx","path":"/spring/why-oidc-flow-execute/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h1>Spring Boot OAuth2 Client와 Google 연동 시 openid scope 관련 에러</h1>\n<p>Spring Boot OAuth2 Client를 사용하여 Google과 연동할 때,\nscope에 <code class=\"language-text\">openid</code>를 포함하면 <code class=\"language-text\">CustomUserDetailsService</code>가 동작하지 않는 에러가 발생했다.</p>\n<h2>에러 발생 원인</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 715px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/eff334ef339fe87f68b513d92a6bc77b/277d6/google-scope.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.52083333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABpklEQVR42p1SaWvjMBT0//9rXQiBEKjr+0hc37osH7KnT3IburCfVjA8+d0zljdwhbpp4b+/IwxD+L6PJEmgtYZSymGapn/CxdR04tvn7Qew7zvWdcW2bS/7v8dblhlpmqCqKmRZ9kKe5+RPEcfxX/coihyDJEpRBBWKsEIZPpHFObGabMMFjHEEQYDL5YLr9epwu91wv99dsR3weDzORoSiKM6hKQ1KaIEkR57lTibP0rVbLkTVNp/nxVlL3RiD4zgcfp8f3+/YT423bgblswYbR0gpoQhSiO/knfQ1MKSpnT7PM0G7QXYRa4059e7aFoJzeANfcfmQ7k93AwcTE6q6I6swcgmhNPpRIIiIblYgIopNN1BMUWx+QWlit2zUUBr88Sm4AOO0Ew4UNUeYNQiyGvknQ085yaNDUnbIqgExWYuyERjUjoHqbI7QOzUUBm++BNens5cbNWRo2IxebFRg0PIF2bN3/pKQU9OyHtGMs1vC5thauez2L6+oPjuMjIELSdoczg4jo4eqnT5az2jazslSNw1auls09N0PAwTlK3rcVvcvP9367fADPPgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/eff334ef339fe87f68b513d92a6bc77b/a59e9/google-scope.webp 192w,\n/static/eff334ef339fe87f68b513d92a6bc77b/0ca9f/google-scope.webp 384w,\n/static/eff334ef339fe87f68b513d92a6bc77b/891ea/google-scope.webp 715w\"\n              sizes=\"(max-width: 715px) 100vw, 715px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/eff334ef339fe87f68b513d92a6bc77b/3b721/google-scope.png 192w,\n/static/eff334ef339fe87f68b513d92a6bc77b/66595/google-scope.png 384w,\n/static/eff334ef339fe87f68b513d92a6bc77b/277d6/google-scope.png 715w\"\n            sizes=\"(max-width: 715px) 100vw, 715px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/eff334ef339fe87f68b513d92a6bc77b/277d6/google-scope.png\"\n            alt=\"Google_Scope\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Google OAuth2 설정에서 다음과 같이 범위를 지정했다.</p>\n<ul>\n<li>email</li>\n<li>profile</li>\n<li>openid</li>\n</ul>\n<p>그리고 Spring Boot 설정에서도 동일하게 scope를 지정했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">security</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">oauth2</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">client</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">registration</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">google</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">client-id</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>GOOGLE_CLIENT_ID<span class=\"token punctuation\">}</span>\n            <span class=\"token key atrule\">client-secret</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>GOOGLE_CLIENT_SECRET<span class=\"token punctuation\">}</span>\n            <span class=\"token key atrule\">scope</span><span class=\"token punctuation\">:</span>\n              <span class=\"token punctuation\">-</span> email\n              <span class=\"token punctuation\">-</span> profile\n              <span class=\"token punctuation\">-</span> openid</code></pre></div>\n<p>또한, <code class=\"language-text\">CustomUserDetailsService</code>를 다음과 같이 구현.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Service</span>\n<span class=\"token keyword\">class</span> <span class=\"token function\">CustomUserDetailsService</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> memberRepository<span class=\"token operator\">:</span> MemberRepository\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span>UserDetailsService<span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">loadUserByUsername</span><span class=\"token punctuation\">(</span>username<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UserDetails <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> member <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByEmail</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">UsernameNotFoundException</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"해당하는 유저가 없습니다. : </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token expression\">username</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> MemberPrincipal<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>하지만 openid가 scope에 포함되어 있으면,\n기본적으로 적용된 <code class=\"language-text\">OAuth2LoginAuthenticationProvider</code> 클래스 내에서 등록한 <code class=\"language-text\">CustomUserDetailsService가</code> 동작하지 않고\n다음 provider로 넘어가게 된다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a806a53c1f502e2da37035a535ce86cb/46d5f/openid-skip-provider.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.0625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABUElEQVR42n3S306DMBQGcF7I0T+UnpZSKDDRaHTebomJm+//Cp+Hs0VvFi9++U5LgPa0VckGfU4IXUJOhD5FrnsZh8QZO0RqZS6mAbHP8BSEaz1aTyxIes6KrMY8Dii5xzL2mEtmA4bUoe8i/yRiZCkSgnegdtPANwZO13BGobnlpqqfToiHM8LHN7sgHC6g9zP825e41me410/opyPs8wn14xH1euQx10yt7JZV7XiLecLw+IK0rOimFWFYflGehetGGOqF9ozu4PnK8jK71sDbGtZo0XAbGvPH3lKrHdSO1Q936XqHyjUNhnFCLjPGeeG6ILOUuY+F5/nZlpvIB+O3/rmWEcgFyU1jHZTmHiqlpHDOIQ8F8zShzHsx71dRlj2fIMEYw6s1ksZYrq9krA201qi27ZFv5Rp0KfNKJyS+GhSifMTTlbWWt6zkpf/8AN1QDG3BRp1PAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/a806a53c1f502e2da37035a535ce86cb/a59e9/openid-skip-provider.webp 192w,\n/static/a806a53c1f502e2da37035a535ce86cb/0ca9f/openid-skip-provider.webp 384w,\n/static/a806a53c1f502e2da37035a535ce86cb/dc9b9/openid-skip-provider.webp 768w,\n/static/a806a53c1f502e2da37035a535ce86cb/e2c2f/openid-skip-provider.webp 1152w,\n/static/a806a53c1f502e2da37035a535ce86cb/09a89/openid-skip-provider.webp 1364w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/a806a53c1f502e2da37035a535ce86cb/3b721/openid-skip-provider.png 192w,\n/static/a806a53c1f502e2da37035a535ce86cb/66595/openid-skip-provider.png 384w,\n/static/a806a53c1f502e2da37035a535ce86cb/fe486/openid-skip-provider.png 768w,\n/static/a806a53c1f502e2da37035a535ce86cb/d2d74/openid-skip-provider.png 1152w,\n/static/a806a53c1f502e2da37035a535ce86cb/46d5f/openid-skip-provider.png 1364w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/a806a53c1f502e2da37035a535ce86cb/fe486/openid-skip-provider.png\"\n            alt=\"SKIP_Provider\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2>해결 방법</h2>\n<p>현재로서는 openid를 scope에서 제거하는 방법으로 해결할 수 있다. openid를 제거하면 CustomUserDetailsService가 정상적으로 동작한다.</p>\n<p>하지만 openid를 사용하는 것이 OAuth2와 OIDC(OpenID Connect)의 차이점과 관련이 있다.\n추후에 OAuth2와 OIDC의 차이점을 정리하여 더 자세히 알아보자</p>","fields":{"category":"spring"},"frontmatter":{"title":"Spring Boot OAuth2 Client 연동 시 scope에 openid를 지정했을 때 발생하는 에러","summary":"Spring Boot OAuth2 Client를 Google과 연동할 때 scope에 openid를 지정하면 발생하는 에러의 원인과 해결 방법을 알아보자.","date":"2022.09.18.","tags":["OAuth2","Spring Boot"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjElEQVR42u2U207CQBCG+8g+go9hYvTCExeoGAWDB2JQsIDFghwUiJwKrXLoAkVUvPidWUAw8cIE4pUXf3e7s/v905lmlZ5dwyKl/AMXC3REfXFAhomWgX5nPqjSIchwYCEQTGBp2YtS8REv3Qm0Do5326zaeBypJ+j9RyAFPwioJ+/hP9cl8K1vwm5U5YHhi4W3nol3h0bHJFl4pZGNBrTuiJrUt082KkX4Azo8xzcIhu9kBmo0De9pHFEtg0TyAXriHvHbrDSOxTO4UlNIp3MQTQNtNm+Pgc2nKjTamM8XcKNlkcsVpI78GtZdIRyQyfZeBKtbIbgPY9h0q3DtRxCOpOAjQzU2Mj670FEghsKHr65TaBGYg+x4QtnG9ax05lpxWdidY9y4SUY8t2mNy1MpF9GwKlCezQplEsbaTghbuypWNi7h8Wl4pfpMOu5Qc7hOfVGXf8PXupiKG8kxhR/sxkUWY/Hmrj3t4uz8V//hrNNsx/4vhz8CitE9MNKcQIY0n8owjBLsliX1CTPZynf2Ss39AAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png","srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/f1689/common.png 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/42fd3/common.png 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png 1080w","sizes":"(min-width: 1080px) 1080px, 100vw"},"sources":[{"srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/7e223/common.webp 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/5cfb6/common.webp 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/941f9/common.webp 1080w","type":"image/webp","sizes":"(min-width: 1080px) 1080px, 100vw"}]},"width":1080,"height":1080}},"publicURL":"/static/a229594a2de7c0ed63d877869e75fd38/common.png"}}}}]}},"pageContext":{"slug":"/spring/why-oidc-flow-execute","category":"spring"}},"staticQueryHashes":["2433549356","3142469158"],"slicesMap":{}}