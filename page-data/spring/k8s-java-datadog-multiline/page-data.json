{"componentChunkName":"component---src-templates-post-template-tsx","path":"/spring/k8s-java-datadog-multiline/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h1>Kubernetes 에서 Datadog을 사용한 멀티라인 로그 설정</h1>\n<p>Kubernetes 환경에서 어플리케이션 로그를 처리하는 방법에는 여러 가지가 있다.</p>\n<ul>\n<li>애플리케이션 레벨에서 직접 로그 수집기로 전달하는 구조</li>\n<li>사이드카에서 로그를 전달하는 구조</li>\n<li>컨테이너의 stdout/stderr을 노드의 파일로 저장한 후, 수집기가 해당 파일을 읽어가는 구조</li>\n</ul>\n<p>마지막 방법을 사용할 때 Datadog 로 로그를 수집할 때 스택트레이스 같은 경우는 하나의 로그로 인식되지 않고\n여러 줄로 인식되어 로그가 분리되어 수집된다. 이런 경우 로그 분석이 어렵고 비용이 증가할 수 있다.</p>\n<h2>멀티라인 로그 설정</h2>\n<p>Datadog에서 스택 트레이스를 하나의 로그로 인식하도록 하려면,\n다음과 같이 Deployment의 Pod 템플릿에 애너테이션을 추가해야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">-</span>deployment\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span>\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx\n  <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">app</span><span class=\"token punctuation\">:</span> nginx\n    <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">ad.datadoghq.com/nginx-service.logs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">></span><span class=\"token punctuation\">-</span>\n      <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n        <span class=\"token key atrule\">\"source\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"java\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token key atrule\">\"service\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"nginx-service\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token key atrule\">\"auto_multi_line_detection\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token key atrule\">\"log_processing_rules\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token punctuation\">{</span>\n            <span class=\"token key atrule\">\"type\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"multi_line\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token key atrule\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"new_log_start_with_date\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token key atrule\">\"pattern\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\\\\d{4}-(0?[1-9]|1[012])-(0?[1-9]|[12][0-9]|3[01])\"</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>이렇게 설정하면 Datadog 에이전트는 Java 애플리케이션에서 출력되는 스택 트레이스를 하나의 로그로 인식하고 처리할 수 있다.</p>","fields":{"category":"spring"},"frontmatter":{"title":"Kubernetes 환경에서 Datadog 로 로그를 수집할 때 Java 멀티라인 설정","summary":"Kubernetes 환경에서 Datadog을 사용해서 로그를 수집할 때,  어플리케이션 로그 설정을 수정하지 않고 멀티라인 설정하는 방법을 알아봅니다.","date":"2022.09.22.","tags":["Kubernetes","Datadog","Logging","Spring"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjElEQVR42u2U207CQBCG+8g+go9hYvTCExeoGAWDB2JQsIDFghwUiJwKrXLoAkVUvPidWUAw8cIE4pUXf3e7s/v905lmlZ5dwyKl/AMXC3REfXFAhomWgX5nPqjSIchwYCEQTGBp2YtS8REv3Qm0Do5326zaeBypJ+j9RyAFPwioJ+/hP9cl8K1vwm5U5YHhi4W3nol3h0bHJFl4pZGNBrTuiJrUt082KkX4Azo8xzcIhu9kBmo0De9pHFEtg0TyAXriHvHbrDSOxTO4UlNIp3MQTQNtNm+Pgc2nKjTamM8XcKNlkcsVpI78GtZdIRyQyfZeBKtbIbgPY9h0q3DtRxCOpOAjQzU2Mj670FEghsKHr65TaBGYg+x4QtnG9ax05lpxWdidY9y4SUY8t2mNy1MpF9GwKlCezQplEsbaTghbuypWNi7h8Wl4pfpMOu5Qc7hOfVGXf8PXupiKG8kxhR/sxkUWY/Hmrj3t4uz8V//hrNNsx/4vhz8CitE9MNKcQIY0n8owjBLsliX1CTPZynf2Ss39AAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png","srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/f1689/common.png 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/42fd3/common.png 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png 1080w","sizes":"(min-width: 1080px) 1080px, 100vw"},"sources":[{"srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/7e223/common.webp 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/5cfb6/common.webp 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/941f9/common.webp 1080w","type":"image/webp","sizes":"(min-width: 1080px) 1080px, 100vw"}]},"width":1080,"height":1080}},"publicURL":"/static/a229594a2de7c0ed63d877869e75fd38/common.png"}}}}]}},"pageContext":{"slug":"/spring/k8s-java-datadog-multiline/","category":"spring"}},"staticQueryHashes":["2433549356","3142469158"],"slicesMap":{}}