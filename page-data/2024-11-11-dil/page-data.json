{"componentChunkName":"component---src-templates-post-template-tsx","path":"/2024-11-11-dil/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h1>상세 설계</h1>\n<h2>중요 구성 요소별 규모 확장성</h2>\n<h3>API 서버</h3>\n<p>생략</p>\n<h3>사용자 데이터베이스 및 위치 정보 캐시(레디스)</h3>\n<p>부하분산 -> 샤딩 처리\n가용성 -> 복제본 처리\n사용자 ID 기준으로 샤딩 가능</p>\n<h3>웹소켓 서버</h3>\n<ul>\n<li>\n<p>유상태 서버</p>\n<blockquote>\n<p>AWS ALB 에서 WSS, WS 지원, Sticky Session 설정, idle 타임 고려(기본 60초)</p>\n</blockquote>\n</li>\n<li>\n<p>서버를 제거할 때 추가적인 연결이 맺어지지 않게 Draining 시키고\n기존 연결이 끊기길 시간이 흐른뒤 서버를 제거</p>\n<blockquote>\n<p>AWS Target Group Connection Draining 찾아보기</p>\n</blockquote>\n</li>\n</ul>\n<h3>클라이언트 초기화</h3>\n<ol>\n<li>\n<p>클라이언트가 초기화되면 웹소켓 서버에 사용자의 위치정보 전송</p>\n</li>\n<li>\n<p>본인 위치 정보 캐시 업데이트</p>\n</li>\n<li>\n<p>사용자 데이터베이스로부터 친구목록 조회</p>\n</li>\n<li>\n<p>친구들의 위치정보 캐시 조회</p>\n</li>\n<li>\n<p>본인과 친구들 데이터들을 계산하여 클라이언트에 반환</p>\n</li>\n<li>\n<p>웹소켓 서버는 각 친구들의 레디스 서버 펍/섭 채널을 구독.</p>\n<blockquote>\n<p>활성 친구 사용자의 채널만 구독하는게 아니라 모든 친구의 채널을 구독하는 이유?</p>\n<p>채널을 유지하는데는 메모리가 필요한것은 사실이지만 비용이 소량이고 활성화가 되기 전까지는 CPU, I/O 리소스를 사용하지\n않는다.</p>\n</blockquote>\n</li>\n<li>\n<p>레디스 펍/섭</p>\n<ol>\n<li>채널을 만드는 비용이 저렴.</li>\n<li>구독자가 없는 채널로 보내는 메시지는 그대로 버려짐. 이 때 부하는 거의 없다.</li>\n<li>구독자 관계를 유지하기 위한 해시 테이블과 연결 리스트가 필요한데 아주 소량의 메모리</li>\n<li>오프라인 사용자라 어떤 변경도 없는 채널의 경우 생성된 이후 CPU 자원을 전혀 사용하지 않음.</li>\n</ol>\n<p>4번의 특징으로 모든 친구의 채널을 구독한다.\n이렇게 되면 활성상태, 비활성 상태의 채널을 유지, 삭제하는 아키텍처비용을 줄일 수 있음.</p>\n</li>\n<li>\n<p>얼마나 많은 레디스 펍/섭이 필요할까?</p>\n<ul>\n<li>메모리</li>\n</ul>\n<blockquote>\n<p>주변 친구 기능을 사용하는 유저 = 1억 => 1억개의 채널\n1인당 활성친구 100명, 해시 테이블과 연결리스트에 20바이트 사용\n1억 * 100 * 20 = 200GB</p>\n</blockquote>\n<ul>\n<li>CPU</li>\n</ul>\n<blockquote>\n<p>펍/섭 서버가 클라이언트에 위치정보 전송 업데이트 양 = 1400만건/초\n기가비트 네트워크 카드 서버 한대감당 가능한 구독자 수 = 100,000\n1400만건/초 / 100,000 = 140대</p>\n</blockquote>\n</li>\n</ol>","frontmatter":{"title":"대규모 시스템 설계 기초 2 DIL","summary":"2장 주변친구","date":"2024.11.11.","categories":["study","DIL"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjElEQVR42u2U207CQBCG+8g+go9hYvTCExeoGAWDB2JQsIDFghwUiJwKrXLoAkVUvPidWUAw8cIE4pUXf3e7s/v905lmlZ5dwyKl/AMXC3REfXFAhomWgX5nPqjSIchwYCEQTGBp2YtS8REv3Qm0Do5326zaeBypJ+j9RyAFPwioJ+/hP9cl8K1vwm5U5YHhi4W3nol3h0bHJFl4pZGNBrTuiJrUt082KkX4Azo8xzcIhu9kBmo0De9pHFEtg0TyAXriHvHbrDSOxTO4UlNIp3MQTQNtNm+Pgc2nKjTamM8XcKNlkcsVpI78GtZdIRyQyfZeBKtbIbgPY9h0q3DtRxCOpOAjQzU2Mj670FEghsKHr65TaBGYg+x4QtnG9ax05lpxWdidY9y4SUY8t2mNy1MpF9GwKlCezQplEsbaTghbuypWNi7h8Wl4pfpMOu5Qc7hOfVGXf8PXupiKG8kxhR/sxkUWY/Hmrj3t4uz8V//hrNNsx/4vhz8CitE9MNKcQIY0n8owjBLsliX1CTPZynf2Ss39AAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png","srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/f1689/common.png 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/42fd3/common.png 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png 1080w","sizes":"(min-width: 1080px) 1080px, 100vw"},"sources":[{"srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/7e223/common.webp 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/5cfb6/common.webp 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/941f9/common.webp 1080w","type":"image/webp","sizes":"(min-width: 1080px) 1080px, 100vw"}]},"width":1080,"height":1080}},"publicURL":"/static/a229594a2de7c0ed63d877869e75fd38/common.png"}}}}]}},"pageContext":{"slug":"/2024-11-11-dil/"}},"staticQueryHashes":[],"slicesMap":{}}