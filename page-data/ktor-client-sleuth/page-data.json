{
    "componentChunkName": "component---src-templates-post-template-tsx",
    "path": "/ktor-client-sleuth/",
    "result": {"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h2>프로젝트 셋업</h2>\n<p>우선 테스트 프로젝트가 멀티모듈(client, server) 로 구성되어 있기 때문에 각각의 의존성을 알아서 설정해주면 된다.\n추가로 client 쪽에서는 ktor-client dependency를 추가로 포함시켜주자</p>\n<p>project-client dependency</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlindsl\"><pre class=\"language-kotlindsl\"><code class=\"language-kotlindsl\">dependencies {\n    implementation(project(&quot;:support:logging&quot;))\n    implementation(&quot;io.ktor:ktor-client-core:${rootProject.extra[&quot;ktorVersion&quot;]}&quot;)\n    implementation(&quot;io.ktor:ktor-client-cio:${rootProject.extra[&quot;ktorVersion&quot;]}&quot;)\n    implementation(&quot;org.springframework.boot:spring-boot-starter-web&quot;)\n}</code></pre></div>\n<p>project-server dependency</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlindsl\"><pre class=\"language-kotlindsl\"><code class=\"language-kotlindsl\">dependencies {\n    implementation(project(&quot;:support:logging&quot;))\n    implementation(&quot;org.springframework.boot:spring-boot-starter-web&quot;)\n}</code></pre></div>\n<p>공통 logging 모듈</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin-dsl\"><pre class=\"language-kotlin-dsl\"><code class=\"language-kotlin-dsl\">dependencies {\n    implementation(&quot;org.springframework.cloud:spring-cloud-starter-sleuth&quot;)\n} </code></pre></div>\n<h3>ktor-client features</h3>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> SleuthHeader <span class=\"token keyword\">internal</span> <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">val</span> tracer<span class=\"token operator\">:</span> Tracer\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> Config <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">internal</span> <span class=\"token keyword\">lateinit</span> <span class=\"token keyword\">var</span> tracer<span class=\"token operator\">:</span> Tracer\n\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">tracer</span><span class=\"token punctuation\">(</span>tracer<span class=\"token operator\">:</span> Tracer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>tracer <span class=\"token operator\">=</span> tracer\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">setupRequest</span><span class=\"token punctuation\">(</span>client<span class=\"token operator\">:</span> HttpClient<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        client<span class=\"token punctuation\">.</span>requestPipeline<span class=\"token punctuation\">.</span><span class=\"token function\">intercept</span><span class=\"token punctuation\">(</span>HttpRequestPipeline<span class=\"token punctuation\">.</span>State<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">val</span> span <span class=\"token operator\">=</span> tracer<span class=\"token punctuation\">.</span><span class=\"token function\">currentSpan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?:</span> tracer<span class=\"token punctuation\">.</span><span class=\"token function\">nextSpan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            context<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"X-B3-TraceId\"</span><span class=\"token punctuation\">,</span> span<span class=\"token punctuation\">.</span><span class=\"token function\">context</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">traceId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            context<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"X-B3-SpanId\"</span><span class=\"token punctuation\">,</span> tracer<span class=\"token punctuation\">.</span><span class=\"token function\">nextSpan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">context</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">spanId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            context<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"X-B3-ParentSpanId\"</span><span class=\"token punctuation\">,</span> tracer<span class=\"token punctuation\">.</span><span class=\"token function\">nextSpan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">context</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">parentId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> HttpClientFeature<span class=\"token operator\">&lt;</span>Config<span class=\"token punctuation\">,</span> SleuthHeader<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">val</span> key<span class=\"token operator\">:</span> AttributeKey<span class=\"token operator\">&lt;</span>SleuthHeader<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">AttributeKey</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SleuthHeaderPlugin\"</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">install</span><span class=\"token punctuation\">(</span>feature<span class=\"token operator\">:</span> SleuthHeader<span class=\"token punctuation\">,</span> scope<span class=\"token operator\">:</span> HttpClient<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            feature<span class=\"token punctuation\">.</span><span class=\"token function\">setupRequest</span><span class=\"token punctuation\">(</span>scope<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span>block<span class=\"token operator\">:</span> Config<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> Unit<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> SleuthHeader <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">val</span> config <span class=\"token operator\">=</span> <span class=\"token function\">Config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">SleuthHeader</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>tracer<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Configuration</span>\n<span class=\"token keyword\">class</span> KtorConfiguration <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation builtin\">@Bean</span>\n    <span class=\"token annotation builtin\">@Primary</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">httpClient</span><span class=\"token punctuation\">(</span>objectMapper<span class=\"token operator\">:</span> ObjectMapper<span class=\"token punctuation\">,</span> tracer<span class=\"token operator\">:</span> Tracer<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> HttpClient <span class=\"token operator\">=</span> <span class=\"token function\">HttpClient</span><span class=\"token punctuation\">(</span>CIO<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">install</span><span class=\"token punctuation\">(</span>SleuthHeader<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">tracer</span><span class=\"token punctuation\">(</span>tracer<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n       \n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"ktor-client sleuth 적용하기","summary":"ktor client 에서 sleuth 를 적용하는 방법을 알아봅니다.","date":"2022.09.25.","categories":["ktor"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAABwklEQVQ4y+VU207CQBDtH/sJ/oYx0UQl8oDRxEtUgsYLVitQUBAQIyAFKkJbKCJGkz1mhhYqYsBLfPHhZDK72zNnZs9Wss0yfgHCNspomWUh/UPClqHxIkUXbv5jwraH6NuEfTKrDKvei6PUjskHhM2GhpeOjtBBAlPTGyjkb9FpVvrVab9paL3owRCxcCMTvnZ0xBMZbIdUJnxuV2E8lPjwy6OOrl3ltW7biXaVSZ9aFR5Tm1p2WueWS3d57OypWNuK4DB8wUSyksTmbgxKJIXERQZqPI2omubC59ErHMuXSKayMOslGLXSQGH9/o4P5nI3fPD6OsdY34li3n/CRXwrp5j1HSOwrmAxIGN59QwnZ0lsBmOQlRQVFsH9OHEIKZvN4Ui+BBGfKimuSGpjaprbdudICmjPIkXOOKyGBvOBc1Es3KKmF4VUqxYx7w9jbjmMpYCMmYUjrG5F0LUrfONee1DuYmhd0EVSlFzvkWUsVvDRGhNgMMPPDPxFg79/KaPgVfknP4ehou99OB78sWixgflj4ZAIZ36DGU7++DVQW314VNJL4dufQKGjgklEP3eUkU3q9wWhaXlhNnSYDV28AXiLyL1VwKH9AAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png","srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/f1689/common.png 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/42fd3/common.png 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png 1080w","sizes":"(min-width: 1080px) 1080px, 100vw"},"sources":[{"srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/7e223/common.webp 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/5cfb6/common.webp 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/941f9/common.webp 1080w","type":"image/webp","sizes":"(min-width: 1080px) 1080px, 100vw"}]},"width":1080,"height":1080}},"publicURL":"/static/a229594a2de7c0ed63d877869e75fd38/common.png"}}}}]}},"pageContext":{"slug":"/ktor-client-sleuth/"}},
    "staticQueryHashes": []}