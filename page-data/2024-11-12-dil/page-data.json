{"componentChunkName":"component---src-templates-post-template-tsx","path":"/2024-11-12-dil/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h3>분산 레디스 펍/섭 클러스터</h3>\n<ul>\n<li>메시지를 발행할 사용자 ID 기준으로 샤딩</li>\n<li>하지만 장애 대비 및 매끄럽게 운영을 위해 서비스 탐색 컴포넌트를 도입 (etcd, zookeeper)</li>\n</ul>\n<h3>서비스 탐색 컴포넌트</h3>\n<p>서비스 탐색 컴포넌트 중에 다음의 기능 두가지를 사용.</p>\n<ol>\n<li>채널을 기준으로 레디스 펍/섭을 찾을 수 있게 해주는 해시링 기능</li>\n<li>Client로 하여금 레디스 펍/섭 변경사항을 구독할 수 있도록 하는 기능</li>\n</ol>\n<blockquote>\n<p>클러스터 내에 레디스 펍/섭 추가, 삭제, 새로 교체하는 경우</p>\n</blockquote>\n<p>웹소켓 서버가 특정 사용자 채널에 위치 정보 변경 내역을 발행하는 과정 OR\n구독할 채널이 어디 레디스 펍/섭에 존재하는지</p>\n<ol>\n<li>웹소켓 서버는 서비스 탐색 컴포넌트로부터 해시링을 참조하여 레디스 펍/섭을 찾음.\n<blockquote>\n<p>이 때 성능 효율을 위해 캐시를 활용할 수 있으나 서비스 디스커버리에 구독 관계를 설정해서 원본을 항상 유지.</p>\n</blockquote>\n</li>\n<li>해당 레디스 펍/섭에 발행</li>\n</ol>\n<h3>레디스 펍/섭 서버 클러스터의 규모 확장시 고려사항.</h3>\n<p>레디스 펍/섭 서버의 기본적인 특성.</p>\n<ol>\n<li>전송되는 메시지는 메모리나 디스크에 지속적으로 보관되지 않음. 구독자에게 전송되고나면 바로 삭제.\n구독자가 없는 경우는 그냥 사라짐.\n<blockquote>\n<p>이 관점에서 보면 무상태 서버로 볼 수 있음.</p>\n</blockquote>\n</li>\n<li>하지만 채널의 구독자 목록은 상태 정보의 핵심적 부분. 특정한 채널을 담당하는 서버가 교체되거나 사라지는 경우\n<blockquote>\n<p>해당 채널의 모든 구독자에게 새로운 서버로 구독을 변경하도록 알려줘야 함.\n이런 특징 때문에 유상태 서버임.</p>\n</blockquote>\n</li>\n</ol>\n<p>이런 특징 때문에 규모를 늘리거나 줄이는 것은 위험 요소가 있음.\n대부분 오버 프로비저닝하는것이 보통.</p>\n<p>하지만 불가피하게 규모를 늘리는 경우 다음의 문제가 발생할 수 있음.</p>\n<ul>\n<li>많은 채널들이 해시 링 위의 다른 여러 서버로 이동하게 됨.</li>\n<li>서비스 탐색 컴포넌트는 클라이언트에게 해시링이 갱신되었음을 알림.</li>\n<li>웹 소켓 서버는 많은 재구독 요청을 처리하게 됨.</li>\n<li>이 때 위치 정보 변경 메시지의 처리가 누락될 가능성이 있음. 하지만 그 정도의 손실을 허용.</li>\n</ul>\n<h3>운영 고려사항.</h3>\n<p>기존 레디스 펍/섭 서버에 문제가 생겨 교체해야하는 상황.</p>\n<ol>\n<li>서비스 탐색 컴포넌트의 해시 링 키에 매달린 값을 갱신. 문제가 발생한 노드와 교체</li>\n<li>교체 사실은 모든 웹 소켓서버에 통보.</li>\n<li>웹 소켓 서버는 교체된 레디스 펍/섭에 있는 채널들을 새로운 레디스 펍/섭으로 구독.</li>\n</ol>\n<h3>친구 추가/ 삭제</h3>\n<ul>\n<li>친구 추가, 친구 삭제의 콜백을 웹 소켓 서버로 받음.</li>\n<li>웹 소켓 서버는 해당 친구가 활성화 상태면 최근 위치 및 시각 정보를 보냄.</li>\n</ul>\n<h3>친구가 많은 사용자</h3>\n<ul>\n<li>친구는 양방향 관계라고 가정</li>\n<li>최대 상한 5000</li>\n</ul>\n<p>수천 명의 친구를 구독하는데 필요한 펍/섭 구독 관계는 클러스터 전체에 걸쳐 분산되어 있음.\n-> 웹 소켓 서버에 분산되어있음.\n많은 친구를 가진 사용자의 채널이 존재하는 레디스 펍/섭은 조금 더 많은 부하를 받을 수도 있음.</p>\n<h3>주변의 임의 사용자</h3>\n<p>주변의 동의를 구한 임의 사용자를 보여주는 기능을 추가해보자.</p>\n<ol>\n<li>지오해시에 기반한 레디스 펍/섭 채널을 만들어 둠.</li>\n</ol>\n<h3>레디스 펍/섭 대안</h3>\n<p>얼랭(Erlang) 한번 사용해보자</p>\n<ol>\n<li>분산 병렬 어플리케이션을 위한 언어 및 런타임 환경</li>\n<li>경량 프로세스</li>\n<li>여러 서버로 분산이 쉬움.</li>\n<li>운영 부담이 낮음, 프로덕션에서 발생하는 이슈 추적, 디버깅을 위한 도구가 훌륭</li>\n</ol>\n<p>웹소켓 서버를 얼랭, 레디스 펍/섭 클러스터는 분산 얼랭 어플리케이션</p>","frontmatter":{"title":"대규모 시스템 설계 기초 2 DIL","summary":"2장 주변친구","date":"2024.11.12.","categories":["study","DIL"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjElEQVR42u2U207CQBCG+8g+go9hYvTCExeoGAWDB2JQsIDFghwUiJwKrXLoAkVUvPidWUAw8cIE4pUXf3e7s/v905lmlZ5dwyKl/AMXC3REfXFAhomWgX5nPqjSIchwYCEQTGBp2YtS8REv3Qm0Do5326zaeBypJ+j9RyAFPwioJ+/hP9cl8K1vwm5U5YHhi4W3nol3h0bHJFl4pZGNBrTuiJrUt082KkX4Azo8xzcIhu9kBmo0De9pHFEtg0TyAXriHvHbrDSOxTO4UlNIp3MQTQNtNm+Pgc2nKjTamM8XcKNlkcsVpI78GtZdIRyQyfZeBKtbIbgPY9h0q3DtRxCOpOAjQzU2Mj670FEghsKHr65TaBGYg+x4QtnG9ax05lpxWdidY9y4SUY8t2mNy1MpF9GwKlCezQplEsbaTghbuypWNi7h8Wl4pfpMOu5Qc7hOfVGXf8PXupiKG8kxhR/sxkUWY/Hmrj3t4uz8V//hrNNsx/4vhz8CitE9MNKcQIY0n8owjBLsliX1CTPZynf2Ss39AAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png","srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/f1689/common.png 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/42fd3/common.png 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png 1080w","sizes":"(min-width: 1080px) 1080px, 100vw"},"sources":[{"srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/7e223/common.webp 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/5cfb6/common.webp 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/941f9/common.webp 1080w","type":"image/webp","sizes":"(min-width: 1080px) 1080px, 100vw"}]},"width":1080,"height":1080}},"publicURL":"/static/a229594a2de7c0ed63d877869e75fd38/common.png"}}}}]}},"pageContext":{"slug":"/2024-11-12-dil/"}},"staticQueryHashes":[],"slicesMap":{}}