{"componentChunkName":"component---src-templates-post-template-tsx","path":"/TIL/2024-11-18-dil/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h1>상세 설계</h1>\n<h2>데이터 모델</h2>\n<h3>경로 안내 타일</h3>\n<ol>\n<li>원본데이터는 가공되지 않은 데이터이므로 주기적으로 데이터 가공 파이프라인을 실행하여 경로 안내 타일로 변환한다.</li>\n<li>해상도를 달리하여 3벌을 만든다.</li>\n<li>그래프에는 노드와 선분이 있으며 다른 타일의 도로와 연결되는 경우 참조 정보도 포함.</li>\n<li>메모리에 인접 리스트로 저장하는것이 일반적이나 양이 너무 많기 때문에 S3 같은 객체 저장소에 이진 파일로 직렬화 하여 보관.</li>\n<li>경로 안내 서비스에서 S3에 저장된 파일을 적절히 캐싱</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> pickle\n<span class=\"token keyword\">import</span> boto3\n<span class=\"token keyword\">from</span> typing <span class=\"token keyword\">import</span> Dict<span class=\"token punctuation\">,</span> List\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Graph</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>adj_list<span class=\"token punctuation\">:</span> Dict<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> List<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">def</span> <span class=\"token function\">add_edge</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> u<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> u <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> self<span class=\"token punctuation\">.</span>adj_list<span class=\"token punctuation\">:</span>\n            self<span class=\"token punctuation\">.</span>adj_list<span class=\"token punctuation\">[</span>u<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">if</span> v <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> self<span class=\"token punctuation\">.</span>adj_list<span class=\"token punctuation\">:</span>\n            self<span class=\"token punctuation\">.</span>adj_list<span class=\"token punctuation\">[</span>v<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n        self<span class=\"token punctuation\">.</span>adj_list<span class=\"token punctuation\">[</span>u<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">save_graph_to_s3</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">:</span> Graph<span class=\"token punctuation\">,</span> bucket<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"인접리스트를 S3에 저장\"\"\"</span>\n    <span class=\"token comment\"># S3 클라이언트 생성</span>\n    s3_client <span class=\"token operator\">=</span> boto3<span class=\"token punctuation\">.</span>client<span class=\"token punctuation\">(</span><span class=\"token string\">'s3'</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token comment\"># 그래프를 바이너리로 직렬화</span>\n    serialized_graph <span class=\"token operator\">=</span> pickle<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">.</span>adj_list<span class=\"token punctuation\">)</span>\n    \n    <span class=\"token comment\"># S3에 업로드</span>\n    s3_client<span class=\"token punctuation\">.</span>put_object<span class=\"token punctuation\">(</span>\n        Bucket<span class=\"token operator\">=</span>bucket<span class=\"token punctuation\">,</span>\n        Key<span class=\"token operator\">=</span>key<span class=\"token punctuation\">,</span>\n        Body<span class=\"token operator\">=</span>serialized_graph\n    <span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">load_graph_from_s3</span><span class=\"token punctuation\">(</span>bucket<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> Graph<span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"S3에서 인접리스트 로드\"\"\"</span>\n    <span class=\"token comment\"># S3 클라이언트 생성</span>\n    s3_client <span class=\"token operator\">=</span> boto3<span class=\"token punctuation\">.</span>client<span class=\"token punctuation\">(</span><span class=\"token string\">'s3'</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token comment\"># S3에서 객체 다운로드</span>\n    response <span class=\"token operator\">=</span> s3_client<span class=\"token punctuation\">.</span>get_object<span class=\"token punctuation\">(</span>Bucket<span class=\"token operator\">=</span>bucket<span class=\"token punctuation\">,</span> Key<span class=\"token operator\">=</span>key<span class=\"token punctuation\">)</span>\n    serialized_graph <span class=\"token operator\">=</span> response<span class=\"token punctuation\">[</span><span class=\"token string\">'Body'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token comment\"># 바이너리를 그래프로 역직렬화</span>\n    graph <span class=\"token operator\">=</span> Graph<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    graph<span class=\"token punctuation\">.</span>adj_list <span class=\"token operator\">=</span> pickle<span class=\"token punctuation\">.</span>loads<span class=\"token punctuation\">(</span>serialized_graph<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> graph\n\n<span class=\"token comment\"># 사용 예시</span>\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 그래프 생성</span>\n    graph <span class=\"token operator\">=</span> Graph<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    graph<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>번 교차로<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span>번도로<span class=\"token punctuation\">)</span>\n    graph<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>번 교차로<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span>번도로<span class=\"token punctuation\">)</span>\n    \n    <span class=\"token comment\"># S3에 저장</span>\n    save_graph_to_s3<span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">,</span> <span class=\"token string\">'my-bucket'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'graphs/지오해시.pkl'</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token comment\"># S3에서 로드</span>\n    loaded_graph <span class=\"token operator\">=</span> load_graph_from_s3<span class=\"token punctuation\">(</span><span class=\"token string\">'my-bucket'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'graphs/지오해시.pkl'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>loaded_graph<span class=\"token punctuation\">.</span>adj_list<span class=\"token punctuation\">)</span></code></pre></div>\n<h3>사용자 위치 데이터</h3>\n<p>도로 데이터 및 경로 안내 타일을 갱신하는데 사용.</p>\n<p>엄청난 쓰기 연산을 잘 처리 가능해야함 -> 카산드라 DB</p>\n<h3>지오코딩 데이터베이스</h3>\n<p>주소를 위도/경도로 변환하는 서비스에 사용됨.\n쓰기가 거의 없고 읽기만 많음 -> Redis</p>\n<h3>미리 만들어 둔 지도 이미지</h3>\n<p>S3 및 CloudFront를 사용하여 저장 및 전송</p>\n<h2>서비스</h2>\n<h3>위치 서비스</h3>\n<p>사용자의 위치는 계속 변화하며 일단 변경되고 나면 이전 정보는 바로 무용해짐.\n데이터 일관성 (Consistency) &#x3C; 가용성 (Availability)</p>\n<p>테이블 구조</p>\n<p>Partition Key : 사용자 ID\nClustering keys : 타임스탬프</p>\n<p>같은 파티션 키를 갖는 데이터는 함께 저장되며 클러스터링 키 값에 따라 정렬됨\n-> 특정 사용자의 특정 기간내 위치도 효율적으로 읽어낼 수 있다.</p>\n<table>\n<thead>\n<tr>\n<th>사용자 ID</th>\n<th>위도</th>\n<th>경도</th>\n<th>타임스탬프</th>\n<th>네비게이션</th>\n<th>유저모드</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>37.123</td>\n<td>127.123</td>\n<td>2024-11-18 12:00:00</td>\n<td>driving</td>\n<td>active</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>사용자 위치는 어떻게 이용되는가?\n데이터 스트리밍 플랫폼(카프카)을 활용하여\n실시간 교통상황, 경로 안내타일 등 다양한 서비스를 개선할 수 있음.</p>\n</blockquote>\n<h3>지도 표시</h3>\n<blockquote>\n<p>벡터 이미지 (SVG)\n파일 용량이 적음, 확대/축소 용이, 복잡한 영역은 렌더링이 느림\nGPU 를 선택적으로 사용가능.</p>\n</blockquote>\n<h3>경로 안내 서비스</h3>\n<ol>\n<li>지오코딩 서비스: 생략</li>\n<li>경로 계획 서비스: 출발지, 목적지의 위도/경도를 받아서 K개의 최단 경로를 반환하는 서비스</li>\n</ol>\n<p>“최단 경로 서비스”, “순위 결정 서비스”, “예상 도착 시간 서비스” 등과 통신하여 결과를 도출.</p>\n<ol start=\"3\">\n<li>최단 경로 서비스\n<ul>\n<li>출발지, 목적지의 지오해시를 계산.</li>\n<li>출발지 타일을 가져와서 그래프 자료 구조를 탐색해 나감.</li>\n<li>인접한 타일이 필요한 경우 객체 저장소 또는 캐시에서 가져옴.</li>\n<li>이 때 해당 타일의 다른 확대 수준 타일도 가져와야함.</li>\n<li>경로가 충분히 확될 떄 까지 탐색을 반복.</li>\n</ul>\n</li>\n<li>예상 도착 시간 서비스(ETA Service)</li>\n</ol>\n<p>“최단 경로 서비스” 목록을 수신하면 각 경로의 예상 도착 시간을 계산하여 반환.\n기계학습을 활용해 현재 교통 상황 및 과거 이력에 근거</p>\n<ol start=\"5\">\n<li>순위 결정 서비스</li>\n</ol>\n<p>ETA 예정치를 구하면 사용자가 정의한 필터링 조건을 적용</p>\n<ol start=\"6\">\n<li>중요 정보 갱신 서비스 (카프카 스트림)\n<ol>\n<li>실시간 교통 정보 데이터베이스</li>\n<li>경로 안내 타일</li>\n</ol>\n</li>\n</ol>","fields":{"category":"TIL"},"frontmatter":{"title":"대규모 시스템 설계 기초 2 TIL","summary":"3장 구글 맵","date":"2024.11.18.","tags":["study","TIL"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjElEQVR42u2U207CQBCG+8g+go9hYvTCExeoGAWDB2JQsIDFghwUiJwKrXLoAkVUvPidWUAw8cIE4pUXf3e7s/v905lmlZ5dwyKl/AMXC3REfXFAhomWgX5nPqjSIchwYCEQTGBp2YtS8REv3Qm0Do5326zaeBypJ+j9RyAFPwioJ+/hP9cl8K1vwm5U5YHhi4W3nol3h0bHJFl4pZGNBrTuiJrUt082KkX4Azo8xzcIhu9kBmo0De9pHFEtg0TyAXriHvHbrDSOxTO4UlNIp3MQTQNtNm+Pgc2nKjTamM8XcKNlkcsVpI78GtZdIRyQyfZeBKtbIbgPY9h0q3DtRxCOpOAjQzU2Mj670FEghsKHr65TaBGYg+x4QtnG9ax05lpxWdidY9y4SUY8t2mNy1MpF9GwKlCezQplEsbaTghbuypWNi7h8Wl4pfpMOu5Qc7hOfVGXf8PXupiKG8kxhR/sxkUWY/Hmrj3t4uz8V//hrNNsx/4vhz8CitE9MNKcQIY0n8owjBLsliX1CTPZynf2Ss39AAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png","srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/f1689/common.png 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/42fd3/common.png 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png 1080w","sizes":"(min-width: 1080px) 1080px, 100vw"},"sources":[{"srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/7e223/common.webp 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/5cfb6/common.webp 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/941f9/common.webp 1080w","type":"image/webp","sizes":"(min-width: 1080px) 1080px, 100vw"}]},"width":1080,"height":1080}},"publicURL":"/static/a229594a2de7c0ed63d877869e75fd38/common.png"}}}}]}},"pageContext":{"slug":"/TIL/2024-11-18-dil","category":"TIL"}},"staticQueryHashes":["2433549356","3142469158"],"slicesMap":{}}