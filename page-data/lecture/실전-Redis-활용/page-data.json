{"componentChunkName":"component---src-templates-post-template-tsx","path":"/lecture/실전-Redis-활용/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<blockquote>\n<p>강의 내용 중 필요하다고 생각되는 부분과 개인적인 생각을 포함했습니다.</p>\n</blockquote>\n<p>Redis 특징</p>\n<ul>\n<li>In-Memory 모든 데이터를 RAM에 저장. (백업 및 스냅샷 제외)</li>\n<li>Single Threaded</li>\n<li>Cluster Mode</li>\n<li>Redis Database (RDB) + Append only file (AOF) 통해서 영속성 옵션 제공</li>\n<li>Pub/Sub 통해서 채팅, 알림 기능 구현가능.</li>\n</ul>\n<p>장점:</p>\n<ul>\n<li>빠른 속도</li>\n<li>다양한 데이터타입 지원</li>\n<li>다양한 클라이언트 라이브러리 지원</li>\n</ul>\n<p>주요 사용 사례</p>\n<ul>\n<li>Cache\n<ul>\n<li>OTP</li>\n<li>Session</li>\n</ul>\n</li>\n<li>Rate Limiter\n<ul>\n<li>Fixed Window</li>\n<li>Sliding Window</li>\n</ul>\n</li>\n<li>Message Broker</li>\n<li>실시간 분석, 계산\n<ul>\n<li>Rank, Leaderboard</li>\n<li>Geofencing</li>\n<li>Visitors count</li>\n</ul>\n</li>\n<li>Pub/Sub</li>\n</ul>\n<p>Persistence</p>\n<p>주로 캐시로 사용하지만 데이터 영속성을 위한 옵션을 제공.</p>\n<p>RDB(Redis Database): Point-in-time Snapshot -> 재난 복구(Disaster Recovery) 용이, 복제에 사용</p>\n<ul>\n<li>스냅샷 생성중에 전체적인 레디스 서버 성능저하 발생가능.</li>\n<li>일부 데이터 유실의 위험가능성 존재</li>\n</ul>\n<p>AOF(Append Only File): Redis에 Write 작업을 모두 Log 로 저장.</p>\n<ul>\n<li>RDB 보다 재난 복구에 느림.</li>\n<li>데이터 유실의 위험이 적음.</li>\n</ul>\n<h3>Caching</h3>\n<p>Cache Aside Pattern: Cache Miss 발생시 Database 에서 데이터를 가져오고, Cache Hit 발생시 Cache 에서 데이터를 가져오는 패턴으로 일반적인 패턴</p>\n<h3>Cli check</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ redis-cli\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> <span class=\"token function\">ping</span>\nPONG</code></pre></div>\n<h3>데이터 타입</h3>\n<ul>\n<li>\n<p>Strings: 문자열, 숫자, Serialized object(JSON String) 등 저장.</p>\n<ul>\n<li>SET key value</li>\n<li>MSET key1 value1 key2 value2</li>\n<li>MGET key1 key2</li>\n<li>INCR key # 숫자 증가</li>\n<li>INCRBY price 10 # 숫자 증가</li>\n<li>SET jsonkey ’{“name”: “jake”, “age”: 20}’</li>\n<li>SET server:ko:price 200 # 자주 사용되는 레디스 네이밍 컨벤션</li>\n</ul>\n</li>\n<li>\n<p>List: String 을 Doubled Linked List 로 저장.</p>\n<ul>\n<li>양 끝에 추가 삭제가 O(1) 시간복잡도를 가짐.</li>\n<li>LPUSH queue job1 job2</li>\n<li>RPOP queue</li>\n<li>LPOP queue</li>\n<li>LRANGE queue 0 -1 # 전체 조회</li>\n<li>LRANGE queue -2 -1 # 뒤에서 두번째 아이템 부터 끝까지 조회</li>\n<li>LTRIM queue 0 0 # 첫번째 아이템만 남기고 삭제</li>\n</ul>\n</li>\n<li>\n<p>Set: Unique string 을 저장하는 정렬되지 않은 집합.</p>\n<ul>\n<li>\n<p>SADD user:1:fruits apple banana orange orange</p>\n</li>\n<li>\n<p>SMEMBERS user:1:fruits # 전체 조회</p>\n</li>\n<li>\n<p>SCARD user:1:fruits # 전체 갯수 cardinality</p>\n</li>\n<li>\n<p>SISMEMBER user:1:fruits apple # 멤버 존재 여부 확인</p>\n</li>\n<li>\n<p>SADD user:2:fruits banana orange kiwi</p>\n</li>\n<li>\n<p>SINTER user:1:fruits user:2:fruits # 교집합</p>\n</li>\n<li>\n<p>SUNION user:1:fruits user:2:fruits # 합집합</p>\n</li>\n<li>\n<p>SDIFF user:1:fruits user:2:fruits # 차집합</p>\n</li>\n</ul>\n</li>\n<li>\n<p>Hash: Key-Value 형태로 저장.</p>\n<ul>\n<li>HSET key1 field1 value1 field2 value2</li>\n<li>HGET key1 field1</li>\n<li>HMGET key1 field1 field2 invalid\n<ul>\n<li>invalid field 는 nil 로 반환</li>\n</ul>\n</li>\n<li>HINCRBY key1 field1 10 # 숫자형에서만 사용가능</li>\n</ul>\n</li>\n<li>\n<p>Sorted Set: Set 과 유사하지만 Score 가 추가로 저장되어 정렬이 가능. Score가 같을 경우 사전순으로 정렬.</p>\n<ul>\n<li>ZADD points 10 TeamA 10 TeamB 50 TeamC</li>\n<li>ZRANGE points 0 -1 # 순서를 가지기 때문에 List 처럼 조회 가능</li>\n<li>ZRANGE points 0 -1 REV WITHSCORES # Score 도 함께 조회 + 역순</li>\n<li>ZRANK points TeamA # 순위 조회</li>\n</ul>\n</li>\n<li>\n<p>Stream: Append-only log 에 consumer groups 과 같은 기능을 더한 자료구조</p>\n<ul>\n<li>Unique ID 를 통해서 하나의 entry 를 읽을 때, 시간 복잡도 O(1)</li>\n<li>Consumer Group 을 통해서 여러 Consumer 가 하나의 Stream 을 읽을 수 있음.</li>\n<li>XADD mystream * name jake age 20</li>\n<li>XRANGE mystream - + # 전체 조회</li>\n<li>XDEL mystream ID # 삭제</li>\n</ul>\n</li>\n<li>\n<p>Geospatials: 좌표를 저장하고, 검색하는 데이터 타입</p>\n<ul>\n<li>GEOADD seoul:station 126.9784 37.5665 hongdae</li>\n<li>GEOADD seoul:station 127.0276 37.4979 gangnam</li>\n<li>GEODIST seoul:station hongdae gangnam km # 거리 계산</li>\n</ul>\n</li>\n<li>\n<p>Bitmaps : 실제 데이터 타입은 아니고 String 에 binary operation 을 적용한 것, 최대 42억개 binary 데이터 표현</p>\n<ul>\n<li>SETBIT user:login:25-01-01 123 1 # 25-01-01 날짜에 123 번째 유저 로그인</li>\n<li>SETBIT user:login:25-01-01 456 1 # 25-01-01 날짜에 456 번째 유저 로그인</li>\n<li>SETBIT user:login:25-01-02 123 1 # 25-01-02 날짜에 123 번째 유저 로그인</li>\n<li>BITCOUNT user:login:25-01-01 123 # 25-01-01 날짜에 123 번째 유저 로그인 여부 확인</li>\n<li>BITOP AND result user:login:25-01-01 user:login:25-01-02 # 25-01-01, 25-01-02 날짜에 모두 로그인한 유저 확인\n<ul>\n<li>GETBIT result 123 # 123 번째 유저가 25-01-01, 25-01-02 날짜에 모두 로그인한 유저인지 확인</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>HyperLogLog: 집합의 cardinality 를 추정하는 확률적 자료구조, 정확성을 일부 포기하고 메모리를 절약, 평균 에러율은 0.81%</p>\n<ul>\n<li>Set과 비교하면 Set은 모든 데이터를 저장하지만 HyperLogLog 는 실제값을 저장하지 않는다.</li>\n<li>모든 아이템을 출력해야하는 상황에서는 불가능.</li>\n<li>PFADD fruits apple banana orange kiwi</li>\n<li>PFCOUNT fruits</li>\n<li>메모리 및 에러 비교\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token keyword\">for</span> <span class=\"token variable\"><span class=\"token punctuation\">((</span> i<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;=</span><span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">))</span></span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> redis-cli SADD k1 <span class=\"token variable\">$i</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">done</span>\nredis-cli \nMEMORY USAGE k1 -<span class=\"token operator\">></span> <span class=\"token number\">40296</span>\nSCARD k1 -<span class=\"token operator\">></span> <span class=\"token number\">1000</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token variable\"><span class=\"token punctuation\">((</span> i<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;=</span><span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">))</span></span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> redis-cli PFADD k2 <span class=\"token variable\">$i</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">done</span>\nredis-cli\nMEMORY USAGE k2 -<span class=\"token operator\">></span> <span class=\"token number\">2608</span>\nPFCOUNT k2 -<span class=\"token operator\">></span> <span class=\"token number\">1001</span> <span class=\"token comment\">#오차 발생</span></code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<p>BloomFilter: element 가 집합 안에 포함되어있는 있는지 확인할 수 있는 확률형 자료구조</p>\n<ul>\n<li>정확성을 일부 포기하는 대신 저장공간을 효율적으로 사용</li>\n<li>멤버십 테스트라고 불리는 기능을 구현할 때 자주 사용</li>\n<li>false positive 가 발생할 수 있음. (값이 없는데 있다고 판단)</li>\n<li>값이 존재하는 경우 100% 확실하게 판단 가능</li>\n<li>BF.MADD fruits apple banana orange kiwi</li>\n<li>BF.EXISTS fruits apple</li>\n</ul>\n</li>\n</ul>\n<h3>Redis 특수 명령어</h3>\n<ul>\n<li>\n<p>데이터 만료: 데이터를 특정시간 이후에 만료시키는 기능, 데이터가 만료되자마자 바로 삭제되지는 않고 만료로 표시했다가 백그라운드에서 주기적으로 삭제.</p>\n<ul>\n<li>EXPIRE key 10 # 10초 후 만료</li>\n<li>TTL key # 만료까지 남은 시간 조회</li>\n<li>SETEX key 10 value # 데이터 저장과 10초 후 만료</li>\n</ul>\n</li>\n<li>\n<p>NX/XX 옵션: SET 명령어에 사용되는 옵션, SET 이 동작하지 않는 경우 (nil) 반환</p>\n<ul>\n<li>NX: 해당 Key가 존재하지 않는 경우에만 SET\n<div class=\"gatsby-highlight\" data-language=\"redis\"><pre class=\"language-redis\"><code class=\"language-redis\">    SET key value NX</code></pre></div>\n</li>\n<li>XX: 해당 Key가 존재하는 경우에만 SET\n<div class=\"gatsby-highlight\" data-language=\"redis\"><pre class=\"language-redis\"><code class=\"language-redis\">    SET key value XX</code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<p>Pub/Sub</p>\n<ul>\n<li>두 시스템간에 비동기적으로 통신</li>\n<li>VS Stream: Stream 와 달리 Subscribe 하지 않을 때 발행된 메시지는 수신 불가.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"redis\"><pre class=\"language-redis\"><code class=\"language-redis\">  SUBSCRIBE ch:order ch:payment # 채널 구독\n  PUBLISH ch:order &quot;order message&quot; # 채널에 메시지 발행\n</code></pre></div>\n</li>\n<li>\n<p>Pipeline</p>\n<ul>\n<li>여러 명령어를 한번에 보내는 기능</li>\n<li>네트워크 오버헤드를 줄이고 성능을 향상</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"redis\"><pre class=\"language-redis\"><code class=\"language-redis\">    MULTI\n    SET key1 value1\n    SET key2 value2\n    EXEC</code></pre></div>\n</li>\n<li>\n<p>Transaction</p>\n<ul>\n<li>여러 명령어를 하나의 트랜잭션으로 묶어서 실행</li>\n<li>트랜잭션 실행 중에는 다른 클라이언트의 명령어가 중간에 실행되지 않음.</li>\n<li>롤백이 발생하는 경우 (문법적 에러가 있는 명령어를 큐에 적재하려고 할 때)\n<div class=\"gatsby-highlight\" data-language=\"redis\"><pre class=\"language-redis\"><code class=\"language-redis\">\n  MULTI\n  SET key1 &quot;value1&quot;\n  SADD key1 // SADD 명령어는 인자가 없어서 에러 발생\n  EXEC</code></pre></div>\n</li>\n<li>롤백이 발생하지 않는 경우\n<div class=\"gatsby-highlight\" data-language=\"redis\"><pre class=\"language-redis\"><code class=\"language-redis\">MULTI\nSET key1 &quot;value1&quot;\nINCR key1 // String &quot;value1&quot; 을 숫자로 증가하려고 하면 에러 발생\nSET key2 &quot;value2&quot;\nEXEC</code></pre></div>\nkey1=“value”, key2=“value2” 로 저장되고 INCR 이 실패.</li>\n</ul>\n</li>\n<li>\n<p>Spring Data Redis</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@EnableTransactionManagement</span>\n<span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RedisConfig</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">StringRedisTemplate</span> <span class=\"token function\">redisTemplate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">StringRedisTemplate</span> template <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringRedisTemplate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    template<span class=\"token punctuation\">.</span><span class=\"token function\">setEnableTransactionSupport</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 트랜잭션 활성화</span>\n    <span class=\"token keyword\">return</span> template<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>실제로 롤백을 지원하지 않고 Exception 발생시 Discard 명령어를 실행.\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserService</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">StringRedisTemplate</span> redisTemplate<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">updateUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        redisTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">opsForValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"user:1:name\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"John\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 예외 발생</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n</li>\n</ul>\n<h2>OTP 구현</h2>\n<h2>분산 락</h2>\n<h2>Rate Limiter</h2>\n<h2>SNS Activity Feed</h2>\n<h2>GeoFencing</h2>\n<ul>\n<li>GEOADD gang-nam:burgers 127.0276 37.4979 burger1</li>\n<li>GEOADD gang-nam:burgers 127.0276 37.4979 burger2</li>\n<li>GEORAIDUS gang-nam:burgers 127.0276 37.4979 1 km</li>\n</ul>\n<h2>사용자 온라인 상태</h2>\n<p>사용자의 현재 상태를 표시하는 기능</p>\n<ul>\n<li>실시간성을 완벽히 보장하지는 않는다.</li>\n<li>수시로 변경되는 값</li>\n<li>SETBIT user:1:30 1</li>\n<li>GETBIT user:1:30 -> 1</li>\n<li>GETBIT user:1:31 -> 0</li>\n</ul>\n<h2>방문자 수 계산</h2>\n<p>HyperLogLog 을 사용하여 방문자 수를 대략적으로 추정하는 경우</p>\n<ul>\n<li>PFADD today:users user:1:{timestamp}</li>\n<li>PFCOUNT today:users</li>\n</ul>\n<h2>중복 이벤트 제거</h2>\n<p>BloomFilter 를 사용하여 중복 이벤트를 제거하는 경우</p>\n<p>“user 1 clicked at 00:00:00” 같은 이벤트를 DB에 저장할 때\nDB 체크 로직을 사용하지 않고 BloomFilter 를 사용하여 중복 이벤트를 제거하여서\n부하 분산 가능</p>\n<h2>주의사항</h2>\n<p>대부분의 명령어는 O(1) 시간복잡도를 가지지만, 몇몇 명령어는 O(N) 시간복잡도를 가질 수 있음.</p>\n<p>싱글 스레드 기반이라 오래걸리는 O(N) 명령어를 사용할 때 주의해야함.</p>\n<ul>\n<li>KEYS: 패턴과 일치하는 모든 키를 조회하는 명령어, Production 환경에서 절대 사용 금지 -> 필요하다면 SCAN 사용</li>\n<li>SMEMBERS: Set 에서 모든 멤버를 조회하는 명령어, Set 이 커질수록 시간복잡도 증가</li>\n<li>HGETALL: Hash 에서 모든 필드와 값을 조회하는 명령어, Hash 가 커질수록 시간복잡도 증가</li>\n<li>SORT: List, Set, Sorted Set 에서 정렬을 위해 사용하는 명령어, 정렬을 위해 모든 데이터를 읽어야 하기 때문에 시간복잡도 증가</li>\n</ul>\n<h3>Thundering Herd Problem</h3>\n<p>병렬 요청이 공유 자원에 대해서 접근할 때, 급격한 과부하가 발생하는 문제</p>\n<ul>\n<li>캐시가 만료될 때 발생할 수 있음.</li>\n<li>Cache Aside Pattern: Cache Miss 발생시 Database 에서 부하</li>\n<li>cronjob 으로 주기적으로 캐시가 만료되지 않도록 갱신</li>\n</ul>\n<h3>Stale Cache Invalidation</h3>\n<p>캐시의 유효성이 손실되었거나 변경되었을 때, 캐시를 변경하거나 삭제하는 기술</p>","fields":{"category":"lecture"},"frontmatter":{"title":"실전! Redis 활용","summary":"실전! Redis 활용 강의 정리","date":"2025.01.04.","tags":["lecture"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjElEQVR42u2U207CQBCG+8g+go9hYvTCExeoGAWDB2JQsIDFghwUiJwKrXLoAkVUvPidWUAw8cIE4pUXf3e7s/v905lmlZ5dwyKl/AMXC3REfXFAhomWgX5nPqjSIchwYCEQTGBp2YtS8REv3Qm0Do5326zaeBypJ+j9RyAFPwioJ+/hP9cl8K1vwm5U5YHhi4W3nol3h0bHJFl4pZGNBrTuiJrUt082KkX4Azo8xzcIhu9kBmo0De9pHFEtg0TyAXriHvHbrDSOxTO4UlNIp3MQTQNtNm+Pgc2nKjTamM8XcKNlkcsVpI78GtZdIRyQyfZeBKtbIbgPY9h0q3DtRxCOpOAjQzU2Mj670FEghsKHr65TaBGYg+x4QtnG9ax05lpxWdidY9y4SUY8t2mNy1MpF9GwKlCezQplEsbaTghbuypWNi7h8Wl4pfpMOu5Qc7hOfVGXf8PXupiKG8kxhR/sxkUWY/Hmrj3t4uz8V//hrNNsx/4vhz8CitE9MNKcQIY0n8owjBLsliX1CTPZynf2Ss39AAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png","srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/f1689/common.png 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/42fd3/common.png 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png 1080w","sizes":"(min-width: 1080px) 1080px, 100vw"},"sources":[{"srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/7e223/common.webp 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/5cfb6/common.webp 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/941f9/common.webp 1080w","type":"image/webp","sizes":"(min-width: 1080px) 1080px, 100vw"}]},"width":1080,"height":1080}},"publicURL":"/static/a229594a2de7c0ed63d877869e75fd38/common.png"}}}}]}},"pageContext":{"slug":"/lecture/실전-Redis-활용","category":"lecture"}},"staticQueryHashes":["2433549356","3142469158"],"slicesMap":{}}