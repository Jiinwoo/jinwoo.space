{"componentChunkName":"component---src-templates-post-template-tsx","path":"/system-2-2024-10-30-dil/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h1>지오해시</h1>\n<h2>지오해시 상용 솔루션</h2>\n<h3>Redis Geospatial</h3>\n<p>Spring Data Redis 를 사용해서 Redis Geospatial 을 사용할 수 있다.\n많은 예제가 있어서 나중에 사용한다면 참고하면 좋을 것 같다.</p>\n<h2>특정 지오해시가 주어졌을 때 주변의 지오해시를 계산하는 방법</h2>\n<p>경계값을 검사하고 재귀적으로 계산하는게 제대로 이해가 안되어서 claude 를 활용해서 코드를 작성하고\nprint 문으로 일일이 디버깅해서 어떻게 흘러가는지 파악하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">get_neighbor</span><span class=\"token punctuation\">(</span>geohash<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> direction<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    주어진 지오해시의 특정 방향 인접 영역을 계산합니다.\n\n    Args:\n        geohash: 기준 지오해시 문자열\n        direction: 방향 ('n','s','e','w','ne','nw','se','sw' 중 하나)\n\n    Returns:\n        str: 인접한 지오해시 문자열\n    \"\"\"</span>\n\n    <span class=\"token comment\"># 지오해시 base32 인코딩 문자</span>\n    base32 <span class=\"token operator\">=</span> <span class=\"token string\">'0123456789bcdefghjkmnpqrstuvwxyz'</span>\n\n    <span class=\"token comment\"># 각 문자의 이웃 관계 정의</span>\n    neighbors <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'n'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'bc01fg45238967deuvhjyznpkmstqrwx'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'p0r21436x8zb9dcf5h7kjnmqesgutwvy'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'s'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'238967debc01fg45kmstqrwxuvhjyznp'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'14365h7k9dcfesgujnmqp0r2twvyx8zb'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'e'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'p0r21436x8zb9dcf5h7kjnmqesgutwvy'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'bc01fg45238967deuvhjyznpkmstqrwx'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'w'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'14365h7k9dcfesgujnmqp0r2twvyx8zb'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'238967debc01fg45kmstqrwxuvhjyznp'</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n\n    border <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'n'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'bcfguvyz'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'prxz'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'s'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'0145hjnp'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'028b'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'e'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'prxz'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'bcfguvyz'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'w'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'028b'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'0145hjnp'</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\"># 대각선 방향은 두 방향의 조합</span>\n    <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>direction<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> get_neighbor<span class=\"token punctuation\">(</span>get_neighbor<span class=\"token punctuation\">(</span>geohash<span class=\"token punctuation\">,</span> direction<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> direction<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n    last_ch <span class=\"token operator\">=</span> geohash<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># 마지막 문자</span>\n    parent <span class=\"token operator\">=</span> geohash<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># 마지막 문자를 제외한 부분</span>\n\n    type_idx <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">2</span>\n\n    <span class=\"token comment\"># 경계에 있는 경우</span>\n    <span class=\"token keyword\">if</span> last_ch <span class=\"token keyword\">in</span> border<span class=\"token punctuation\">[</span>direction<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>type_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n        parent <span class=\"token operator\">=</span> get_neighbor<span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> direction<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 이웃 문자 찾기</span>\n    next_idx <span class=\"token operator\">=</span> neighbors<span class=\"token punctuation\">[</span>direction<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>type_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>find<span class=\"token punctuation\">(</span>last_ch<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> next_idx <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n        next_idx <span class=\"token operator\">=</span> base32<span class=\"token punctuation\">.</span>find<span class=\"token punctuation\">(</span>last_ch<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> next_idx <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> parent\n    <span class=\"token keyword\">return</span> parent <span class=\"token operator\">+</span> base32<span class=\"token punctuation\">[</span>next_idx<span class=\"token punctuation\">]</span>\n\n\n<span class=\"token comment\"># wydm2의 모든 인접 영역 계산</span>\ngeohash <span class=\"token operator\">=</span> <span class=\"token string\">'wydm2'</span>\n\nneighbors <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'n'</span><span class=\"token punctuation\">:</span> get_neighbor<span class=\"token punctuation\">(</span>geohash<span class=\"token punctuation\">,</span> <span class=\"token string\">'n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'ne'</span><span class=\"token punctuation\">:</span> get_neighbor<span class=\"token punctuation\">(</span>geohash<span class=\"token punctuation\">,</span> <span class=\"token string\">'ne'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'e'</span><span class=\"token punctuation\">:</span> get_neighbor<span class=\"token punctuation\">(</span>geohash<span class=\"token punctuation\">,</span> <span class=\"token string\">'e'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'se'</span><span class=\"token punctuation\">:</span> get_neighbor<span class=\"token punctuation\">(</span>geohash<span class=\"token punctuation\">,</span> <span class=\"token string\">'se'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'s'</span><span class=\"token punctuation\">:</span> get_neighbor<span class=\"token punctuation\">(</span>geohash<span class=\"token punctuation\">,</span> <span class=\"token string\">'s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'sw'</span><span class=\"token punctuation\">:</span> get_neighbor<span class=\"token punctuation\">(</span>geohash<span class=\"token punctuation\">,</span> <span class=\"token string\">'sw'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'w'</span><span class=\"token punctuation\">:</span> get_neighbor<span class=\"token punctuation\">(</span>geohash<span class=\"token punctuation\">,</span> <span class=\"token string\">'w'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'nw'</span><span class=\"token punctuation\">:</span> get_neighbor<span class=\"token punctuation\">(</span>geohash<span class=\"token punctuation\">,</span> <span class=\"token string\">'nw'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># 결과 출력</span>\n<span class=\"token keyword\">for</span> direction<span class=\"token punctuation\">,</span> value <span class=\"token keyword\">in</span> neighbors<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>direction<span class=\"token punctuation\">}</span></span><span class=\"token string\">: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>value<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<h2>표시할 사업장이 충분하지 않은 경우</h2>\n<p>나중에 어플리케이션 로직상에서 실제로 구현해보면 좋을 것 같다.</p>\n<ol>\n<li>사용자의 지오해시로부터 인접한 지오해시 List 를 반환하고</li>\n<li>인접한 지오해시 List 에서 사업장을 찾는다.</li>\n<li>사업장이 충분하지 않은 경우 인접한 지오해시로부터 인접한 지오해시를 계속 찾는다.</li>\n<li>사업장이 충분해질 때까지 반복한다.</li>\n</ol>","frontmatter":{"title":"대규모 시스템 설계 기초 2 - DIL (2)","summary":"지오해시","date":"2024.10.30.","categories":["study","DIL","지오해시"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjElEQVR42u2U207CQBCG+8g+go9hYvTCExeoGAWDB2JQsIDFghwUiJwKrXLoAkVUvPidWUAw8cIE4pUXf3e7s/v905lmlZ5dwyKl/AMXC3REfXFAhomWgX5nPqjSIchwYCEQTGBp2YtS8REv3Qm0Do5326zaeBypJ+j9RyAFPwioJ+/hP9cl8K1vwm5U5YHhi4W3nol3h0bHJFl4pZGNBrTuiJrUt082KkX4Azo8xzcIhu9kBmo0De9pHFEtg0TyAXriHvHbrDSOxTO4UlNIp3MQTQNtNm+Pgc2nKjTamM8XcKNlkcsVpI78GtZdIRyQyfZeBKtbIbgPY9h0q3DtRxCOpOAjQzU2Mj670FEghsKHr65TaBGYg+x4QtnG9ax05lpxWdidY9y4SUY8t2mNy1MpF9GwKlCezQplEsbaTghbuypWNi7h8Wl4pfpMOu5Qc7hOfVGXf8PXupiKG8kxhR/sxkUWY/Hmrj3t4uz8V//hrNNsx/4vhz8CitE9MNKcQIY0n8owjBLsliX1CTPZynf2Ss39AAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png","srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/f1689/common.png 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/42fd3/common.png 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/d0859/common.png 1080w","sizes":"(min-width: 1080px) 1080px, 100vw"},"sources":[{"srcSet":"/static/a229594a2de7c0ed63d877869e75fd38/7e223/common.webp 270w,\n/static/a229594a2de7c0ed63d877869e75fd38/5cfb6/common.webp 540w,\n/static/a229594a2de7c0ed63d877869e75fd38/941f9/common.webp 1080w","type":"image/webp","sizes":"(min-width: 1080px) 1080px, 100vw"}]},"width":1080,"height":1080}},"publicURL":"/static/a229594a2de7c0ed63d877869e75fd38/common.png"}}}}]}},"pageContext":{"slug":"/system-2-2024-10-30-dil/"}},"staticQueryHashes":[],"slicesMap":{}}