---
date: '2024-11-27'
title: "5장 지표 모니터링 및 경보 시스템"
tags: [ 'study', "TIL" ]
summary: "대규모 시스템 설계 기초 2 5장 지표 모니터링 및 경보 시스템 발표 자료"
thumbnail: '../../common.png'
---

# 지표 모니터링 및 경보 시스템

## 문제 이해 및 설계 범위 확정

### 개략적 요구사항 및 가정

- 대규모 인프라를 모니터링.
    - DAU 1억
    - 서버 풀 1,000대, 풀당 서버 수 100개, 서버당 100개의 운영지표 수집한다고 치면      
      모니터링 해야하는 지표의 수는 천만 개 수준.
    - 데이터 보관 기간은 1년
    - 수집한 그대로 데이터를 보관하는 기간은 일주일. 그 뒤에는 1분 단위데이터로 변환한 후에 30일간 보관. 그 뒤에는 1시간 단위 데이터로 변환한 뒤에 1년간 보관.
- 모니터링 해야할 지표
    - CPU 사용률
    - 메모리 사용률
    - 요청 수
    - 메시지 큐 내의 메시지 수

> AWS CloudWatch 비용
> 1. 기본 메트릭 비용은 무료. 네임스페이스가 AWS/ 로 시작하는 메트릭은 무료.
> 2. 커스텀 메트릭은 별도의 비용이 부과됨.
> 3. CloudWatch API 호출에 비용 발생.

### 비기능 요구사항

- 규모 확장성
- 낮은 응답 지연
    - 대시보드와 경보를 신속하게 처리가능 하도록 질의(query)에 대한 낮은 응답지연을 제공.
- 안정성
- 유연성
    - 미래의 신기술을 쉽게 통합할 수 있도록 설계.

## 개략적 설계안 제시 및 동의 구하기

### 기본적 사항.

- 데이터 수집기: CloudWatch Agent, Telegraf

> 로그 수집: Fluentbit, Logstash

- 데이터 전송
- 데이터 저장소
- 경보: 이상징후 감지 및 다양한 통신 채널로 경보 발송

### 데이터 모델

지표 데이터는 통상 "시계열" 데이터로 저장

모든 시계열 데이터는 다음 정보들로 구성

| 이름               | 자료형               |
|------------------|-------------------|
| 지표 이름            | 문자열               |
| 태그/레비을 집함        | <키:값> 쌍의 리스트      |
| 지표 값 및 타임스탬프의 배열 | <값, 타임스탬프> 쌍의 리스트 |

### 데이터 접근 패턴

- 쓰기 부하는 막대함.
- 읽기 부하는 일시적으로 치솟았다 사라짐 (spike)

### 데이터 저장소 시스템

일반 데이터베이스 및 NoSQL

- 일반 데이터베이스로는 전문가급 튜닝이 필요
- 시계열 데이터 쿼리문 작성이 힘듬.

시계열 데이터베이스

- InfluxDB, OpenTSDB, Prometheus

## 상세 설계

### 지표 수집

일부 지표가 사라져도 괜찮다는 특징을 가지고 있음.

- 풀 모델
    - prometheus 가 대표적
    - Service Discovery 기능의 도움이 필요
      예) [k8s 환경](https://stdhsw.tistory.com/entry/Prometheus%EA%B0%80-Kubernetes-service-discover%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95)
    - 안정 해시 알고리즘을 사용하여 특정 서버에 대한 요청을 분산시킴.
    - 손쉬운 디버깅 가능
    - health check 기능을 제공
    - TCP
- 풀 모델
    - cloudwatch 가 대표적
    - 로드밸런서가 필요
    - UDP
    - 데이터 신빙성 문제가 있으나 Authentication 설정으로 해결가능.

데이터 저장소에 문제가 생기면 데이터 손실이 발생.

큐 시스템(Kafka) 도입으로 문제 해결가능.   
장점

- 데이터 수집 컴포넌트와 처리 컴포넌트간의 결합도를 낮춤.
- 데이터베이스 장애 발생시 카프카 데이터로부터 복구가능.
  단점
- 데이터 저장소에 비해 복잡도가 높음.

### 데이터 집계 지점.

1. 수집 에이전트가 집계
    - 복잡한 집계로직은 힘듬. 분 단위로 집계하여 지표에 보내는 것 정도.

2. 데이터 수집 파이프라인에서 집계
    - 플링크 같은 스트림 프로세싱 엔진이 필요.
    - 늦게 도착하는 지표 데이터의 처리가 힘듬.
    - 원본 데이터를 저장하지 않기 때문에 정밀도나 유연성 측면에서 손해
3. 질의 시에 집계
    - 데이터 손실은 문제 없으나 속도 이슈가 발생가능

### 질의 서비스

- 캐시 계층 도입
  질의 부하를 낮추고 서비스의 성능을 높일 수 있음.

### 질의 서비스를 두면 곤란한 경우

대부분의 시각화 및 경보 시스템은
이미 시계열 데이터베이스와 연동을 처리하는 강력한 플러그인을 갖추고 있는 경우가 대부분.

### 저장소 계층 - 저장 용량 최적화

문제: 지표 모니터링에 저장할 데이터의 양은 많음.

해결방법: 데이터 인코딩 및 압축 기법

1. Timestamp의 차이만 저장하는 방법
2. 다운샘플링 기법
   7일 이내 데이터-> No Sampling   
   7일 이후 데이터 -> 1분 단위 데이터로 변환 후 30일간 보관
3. Cold Storage (AWS Glacier Storage)

### 경보 시스템

- Prometheus Alertmanager
- AWS CloudWatch Alarm

### 시각화 시스템

- Grafana
- AWS Managed Grafana
