---
date: '2024-11-17'
title: "대규모 시스템 설계 기초 2 DIL"
categories: [ 'study', "DIL" ]
summary: "3장 구글 맵"
thumbnail: '../common.png'
---

# 문제 이해 및 설계범위 확정

- 10억 DAU
- 위치 갱신, 경로 안내, ETA, 지도 표시 기능을 제공하는 서비스
- 도로 데이터는 수 TB 규모의 가공되지 않은 데이터 
- 다양한 이동수단 지원

## 개념 
- 웹 메르카토르
- 지오코딩 [국토교통부 지오코딩 API](https://www.data.go.kr/data/15101106/openapi.do?recommendDataYn=Y)
- 지오해싱
- 지도표시
  - 확대 수준에 따른 타일 표시
- 경로 안내 알고리즘을 위한 도로 데이터 처리 (경로 안내 타일) 
  - 다익스트라 알고리즘을 일반적으로 사용
  - 도로망을 노드(교차로)와 엣지(도로)로 구성된 그래프 자료구조로 변환.
  - 하나의 도로망은 도로로 연결된 도로망을 참조관계로 유지.
  - PNG 가 아닌 이진 파일
- 계층적 경로 안내 타일
  - 구체성 정도를 상, 중, 하로 구분하여 경로 안내 타일을 준비

# 개략적 규모 추정.

## 저장소 사용량

### 세계 지도

- 한 장의 타일 256x256 픽셀 약 100KB
  - 256x256x3 = 192KB
  - 무손실 PNG 압축 -> 100KB
- 21번 확대 가능했을 때 타일의 갯수 4^21 약 4.4조
- 100KB * 4.4조 = 440PB
- 90% 는 살지 않는 지역. 압축시 90% 감소 -> 88PB
- 모든 단계의 타일을 전부 합 약 100PB


## 서버 대역폭

요청의 종류
- 경로 안내 요청
- 위치 갱신 요청
- 경로 안내기능을 평균적으로 주당 35분
- 350억 분, 즉 하루에 50억분
- GPS 를 1초마다 전송시 하루에 3000억 요청
- 3000억 / 10^5 = 300만 QPS
- 클라이언트에서 15초마다 데이터를 모아서 보낼 시 20만 QPS
- 최대 QPS 는 다섯배로 가정하면 100만 QPS


# 개략적 설계안 제시 및 동의 구하기

## 위치 서비스
사용자의 위치를 기록하는 역할.

장점.
1. 해당 데이터 스트림을 활용해 시스템을 점차 개선 가능.
   - 실시간 교통상황 모니터링
   - 폐쇄된 도로 탐지.
   - 개인화된 경험.
2. 최적화된 ETA 계산.

많은 쓰기 요청에 적합한 카산드라 데이터베이스.
데이터 스트림 처리를 위해 카프카 사용.

## 경로 안내 서비스
A 에서 B 지점으로 가는 합리적으로 빠른 경로를 찾아주는 역할.

## 지도 표시

1. 동적으로 타일을 만드는 방법.
    - 서버 클러스터에 심각한 부하.
    - 캐시를 활용하기 힘듬.
2. 미리 만들어 놓은 타일을 사용하는 방법.
    - 클라이언트는 지도 타일이 필요한 경우 필요한 위치의 지오해시를 구해서 서버에 요청
    - POP(Point of Presence) 에 캐시 서버를 두어서 빠르게 제공.
3. 주어진 위도/경도 및 확대 수준을 타일 URL 로 변환하는 알고리즘은 별도 서비스에 구현.
