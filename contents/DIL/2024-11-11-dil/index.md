---
date: '2024-11-11'
title: "대규모 시스템 설계 기초 2 DIL"
categories: [ 'study', "DIL" ]
summary: "2장 주변친구"
thumbnail: '../../common.png'
---

# 상세 설계

## 중요 구성 요소별 규모 확장성

### API 서버

생략

### 사용자 데이터베이스 및 위치 정보 캐시(레디스)

부하분산 -> 샤딩 처리
가용성 -> 복제본 처리
사용자 ID 기준으로 샤딩 가능

### 웹소켓 서버

- 유상태 서버

  > AWS ALB 에서 WSS, WS 지원, Sticky Session 설정, idle 타임 고려(기본 60초)

- 서버를 제거할 때 추가적인 연결이 맺어지지 않게 Draining 시키고
  기존 연결이 끊기길 시간이 흐른뒤 서버를 제거

  > AWS Target Group Connection Draining 찾아보기

### 클라이언트 초기화

1. 클라이언트가 초기화되면 웹소켓 서버에 사용자의 위치정보 전송
2. 본인 위치 정보 캐시 업데이트
3. 사용자 데이터베이스로부터 친구목록 조회
4. 친구들의 위치정보 캐시 조회
5. 본인과 친구들 데이터들을 계산하여 클라이언트에 반환
6. 웹소켓 서버는 각 친구들의 레디스 서버 펍/섭 채널을 구독.
   > 활성 친구 사용자의 채널만 구독하는게 아니라 모든 친구의 채널을 구독하는 이유?
   >
   > 채널을 유지하는데는 메모리가 필요한것은 사실이지만 비용이 소량이고 활성화가 되기 전까지는 CPU, I/O 리소스를 사용하지
   > 않는다.
7. 레디스 펍/섭

    1. 채널을 만드는 비용이 저렴.
    2. 구독자가 없는 채널로 보내는 메시지는 그대로 버려짐. 이 때 부하는 거의 없다.
    3. 구독자 관계를 유지하기 위한 해시 테이블과 연결 리스트가 필요한데 아주 소량의 메모리
    4. 오프라인 사용자라 어떤 변경도 없는 채널의 경우 생성된 이후 CPU 자원을 전혀 사용하지 않음.

   4번의 특징으로 모든 친구의 채널을 구독한다.
   이렇게 되면 활성상태, 비활성 상태의 채널을 유지, 삭제하는 아키텍처비용을 줄일 수 있음.

8. 얼마나 많은 레디스 펍/섭이 필요할까?
    - 메모리
   > 주변 친구 기능을 사용하는 유저 = 1억 => 1억개의 채널
   > 1인당 활성친구 100명, 해시 테이블과 연결리스트에 20바이트 사용
   > 1억 * 100 * 20 = 200GB
    - CPU
   > 펍/섭 서버가 클라이언트에 위치정보 전송 업데이트 양 = 1400만건/초
   > 기가비트 네트워크 카드 서버 한대감당 가능한 구독자 수 = 100,000
   > 1400만건/초 / 100,000 = 140대




